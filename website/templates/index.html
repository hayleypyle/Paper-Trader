{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Trader</title>
    <link rel="stylesheet" href="{% static  'css/styles.css'%}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


</head>
<body>
    <div class="header">paper trader</div>
    {% comment %} <div class="directions">
    <p>Use the drop down menu to view different charts containing stock closing data.
    Then input the quantity of shares you wish to purchase or sell in the portfolio.
    Lastly, use the "complete transaction" button to confirm your purchase or sale. </p>
    </div> {% endcomment %}

    <form method="GET" id="tickerform">
        {{form}}
    </form>
    <div class="main-container">
    <div id="apple">
    {% autoescape off %}
    {{aapl_plot_div|safe}}
    {% endautoescape %}
    </div>

    <div class="microsoft-container" id="microsoft">
        {% autoescape off %}
        {{msft_plot_div}}
        {% endautoescape %}
    </div>

    <div class="google-container" id="google">
    {% autoescape off %}
    {{goog_plot_div}}
    {% endautoescape %}
    </div>

<div class="buy-container">
    <h2>portfolio</h2>
    <table>
        <tr>
            <th>stock</th>
            <th>shares owned</th> 
            <th>share price</th>
            <th>buy quantity</th>
            <th>sell quantity</th>
        </tr>
        {% for share in shares %}
        <tr>
            <td>{{share.share_name}}</td>
            <td id="shares-owned-{{share.share_name }}">
                {{share.owned_share}}
            </td>
            <td id="shares-price-{{share.share_name }}">
                {{share.share_price}}
            </td>
        
            <td><input type="text" class="buy-quantity" data-stock="{{share.share_name }}">
                </input>
            </td>

            <td>
                <input type="text" class="sell-quantity" data-stock="{{share.share_name }}">
                </input>
            </td>
        </tr>

        {% endfor %}
    
    </table>
    <div class="money">
    <h4>buy total:$
        <span id="buy-total">0</span>
    </h4>
    <h4>sell total:$
        <span id="sell-total">0</span>
    </h4>
    <h4>final transaction:$
        <span id="transaction-total">0</span>
    </h4>

    <h4>balance: $
        <span class="balance">10000</span>
    </h4>
    <button id= "complete-transaction" class="purchase-button">complete transaction</button>
    </div>

</div>

    <script>

    

        const buyQuantityInputs = document.querySelectorAll('.buy-quantity');
        const sellQuantityInputs = document.querySelectorAll('.sell-quantity');
        const balanceElement = document.querySelectorAll('.balance');
        const sharesOwnedElements = document.querySelectorAll('[id^=shares-owned]');
        let selectElement = document.getElementById('ticker_field');
        let balance = 10000;
        let totalBuy=0;
        let totalSell = 0;
    
        if(selectElement){
            selectElement.addEventListener('change', function() {

                document.getElementById('tickerform').submit();
            });
        }

        buyQuantityInputs.forEach(input => { 
            if(balance <= 10000){
                input.addEventListener('change', function() {

                    totalBuy = 0;
                    buyQuantityInputs.forEach(input=>{
                        const stockName = input.dataset.stock;
                        const sharePriceElement = document.querySelector(`#shares-price-${stockName}`);
                        const buyQuantity = parseInt(input.value)|| 0;
                        const sharePrice = parseFloat(sharePriceElement.textContent)|| 0;
                        const cost = (sharePrice * buyQuantity);
                        totalBuy -= cost
                        
                        
                    });
                    const buyTotalElement = document.getElementById('buy-total');
                    buyTotalElement.textContent = totalBuy;
                    updateTransactionTotal();
                    
                });
        
            }

        });
        
        sellQuantityInputs.forEach(input => {
            input.addEventListener('change', function(){
                totalSell = 0;
                sellQuantityInputs.forEach(input=>{
                    const stockName = input.dataset.stock;
                    const sharePriceElement = document.querySelector(`#shares-price-${stockName}`);
                    const sellQuantity = parseInt(input.value)|| 0;
                    const sharePrice = parseFloat(sharePriceElement.textContent)|| 0;
                    const cost = (sharePrice * sellQuantity);
                    totalSell += cost

                });
                const sellTotalElement = document.getElementById('sell-total');
                sellTotalElement.textContent = totalSell;
                updateTransactionTotal();
                
            });
                


            });
        

        function updateTransactionTotal(){
            const transactionTotalElement = document.getElementById('transaction-total');
            transactionTotalElement.textContent = totalBuy+totalSell;

        }

        document.getElementById('complete-transaction').addEventListener('click', function() {
            const buySellTotal = totalBuy + totalSell;
            balance -= buySellTotal;
            balanceElement.textContent = balance;
        })


        

    </script>
</body>
</html>
